# 跨域登录与图片处理服务集成方案

## 方案概述

本方案旨在解决**不同域名页面**（如 `https://www.meewoo.me/`）使用同一套登录系统并调用 ImgHLP 图片处理服务的问题。

## 核心需求

1. **共享登录系统**：目标页面使用 ImgHLP 统一登录流程
2. **调用图片处理服务**：登录后可调用云函数进行图片处理
3. **跨域支持**：不同域名下的页面能正常工作
4. **用户体验流畅**：登录流程无缝集成，无感知跳转

## 推荐方案

### 方案：基于 Token 的跨域认证 + API 集成

#### 方案优势

* ✅ **实现简单**：基于标准 HTTP 重定向和 URL 参数传递

* ✅ **流程清晰**：用户体验流畅，登录后自动返回目标页面

* ✅ **安全性高**：token 通过 HTTPS 传输，存储在 localStorage

* ✅ **可扩展性强**：支持多个不同域名的页面集成

* ✅ **兼容性好**：支持所有现代浏览器

## 实现步骤

### 一、目标页面改造

#### 步骤 1：添加登录状态检查和重定向逻辑

```javascript
// 在 https://www.meewoo.me/ 页面添加
function checkLoginStatus() {
  const token = localStorage.getItem('authToken');
  if (!token) {
    // 未登录，重定向到登录页面并携带当前URL作为返回地址
    const currentUrl = encodeURIComponent(window.location.href);
    window.location.href = `https://www.imghlp.com/auth/login.html?returnUrl=${currentUrl}`;
    return false;
  }
  return true;
}

// 处理登录回调（从登录页返回时）
function handleLoginCallback() {
  const urlParams = new URLSearchParams(window.location.search);
  const token = urlParams.get('authToken');
  const userInfo = urlParams.get('userInfo');
  
  if (token && userInfo) {
    // 存储 token 和用户信息到本地
    localStorage.setItem('authToken', token);
    localStorage.setItem('userInfo', userInfo);
    
    // 清理 URL 中的 token 参数（避免泄露）
    const cleanUrl = new URL(window.location.href);
    cleanUrl.searchParams.delete('authToken');
    cleanUrl.searchParams.delete('userInfo');
    window.history.replaceState({}, '', cleanUrl.toString());
    
    return true;
  }
  return false;
}

// 页面加载时执行
window.onload = function() {
  if (handleLoginCallback()) {
    // 登录成功，初始化图片处理服务
    initImageProcessingService();
  } else {
    // 检查登录状态
    if (checkLoginStatus()) {
      // 已登录，初始化图片处理服务
      initImageProcessingService();
    }
  }
};
```

#### 步骤 2：集成图片处理 API

```javascript
// 在 https://www.meewoo.me/ 页面添加
const ImgHLP_API = {
  // 云函数配置
  MERGE_API_URL: 'https://imghlp-5gh0mgfu98b71b4e-1258489735.ap-shanghai.app.tcloudbase.com/merge',
  SPLIT_API_URL: 'https://imghlp-5gh0mgfu98b71b4e-1258489735.ap-shanghai.app.tcloudbase.com/split',
  
  // 调用云函数
  async callCloudFunction(url, data) {
    const token = localStorage.getItem('authToken');
    if (!token) {
      throw new Error('请先登录');
    }
    
    const response = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify(data)
    });
    
    if (!response.ok) {
      throw new Error(`API 调用失败: ${response.status}`);
    }
    
    const result = await response.json();
    if (!result.success) {
      throw new Error(result.message || '云函数调用失败');
    }
    
    return result.data;
  },
  
  // 文件转 Base64
  async fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  },
  
  // Base64 转 Blob
  base64ToBlob(base64) {
    const matches = base64.match(/^data:image\/(\w+);base64,(.+)$/);
    if (!matches) {
      throw new Error('无效的 Base64 格式');
    }
    const type = matches[1];
    const buffer = Uint8Array.from(atob(matches[2]), c => c.charCodeAt(0));
    return new Blob([buffer], { type: `image/${type}` });
  },
  
  // 合并图片
  async merge(images) {
    // 转换图片为 Base64
    const imageData = await Promise.all(
      images.map(async (file, index) => ({
        name: file.name || `image_${index}.png`,
        image: await this.fileToBase64(file)
      }))
    );
    
    // 调用云函数
    const data = await this.callCloudFunction(this.MERGE_API_URL, { images: imageData });
    
    // 转换返回结果
    return {
      mergedImage: this.base64ToBlob(data.mergedImage),
      alphaImage: this.base64ToBlob(data.alphaImage),
      positionData: data.positionData
    };
  },
  
  // 切割图片
  async split(mergedImage, positionData) {
    // 转换图片为 Base64
    const imageBase64 = await this.fileToBase64(mergedImage);
    
    // 调用云函数
    const data = await this.callCloudFunction(this.SPLIT_API_URL, {
      mergedImage: imageBase64,
      positionData: positionData
    });
    
    // 转换返回结果
    return data.cutImages.map(item => ({
      filename: item.filename,
      image: this.base64ToBlob(item.image)
    }));
  },
  
  // 检查登录状态
  isLoggedIn() {
    return !!localStorage.getItem('authToken');
  },
  
  // 登出
  logout() {
    localStorage.removeItem('authToken');
    localStorage.removeItem('userInfo');
  }
};

// 使用示例
async function handleMergeImages() {
  try {
    const files = document.getElementById('image-upload').files;
    if (files.length === 0) {
      alert('请选择图片');
      return;
    }
    
    // 调用合并服务
    const result = await ImgHLP_API.merge(Array.from(files));
    
    // 显示结果
    const mergedImg = document.createElement('img');
    mergedImg.src = URL.createObjectURL(result.mergedImage);
    document.getElementById('result-container').appendChild(mergedImg);
    
  } catch (error) {
    console.error('合并失败:', error);
    alert('合并失败，请重试');
  }
}
```

### 二、登录页面改造

修改 `docs/auth/login.html`，支持跨域返回：

```javascript
// 修改登录成功处理逻辑
handleLogin() {
  // 登录成功后
  const token = 'mock-token-' + Date.now();
  const userInfo = { username: this.form.username };
  
  // 获取来源页面地址
  const urlParams = new URLSearchParams(window.location.search);
  const returnUrl = urlParams.get('returnUrl');
  
  if (returnUrl) {
    try {
      // 解析返回 URL
      const parsedUrl = new URL(decodeURIComponent(returnUrl));
      // 在 URL 参数中添加 token 和用户信息
      parsedUrl.searchParams.append('authToken', token);
      parsedUrl.searchParams.append('userInfo', JSON.stringify(userInfo));
      // 跳转到目标页面
      window.location.href = parsedUrl.toString();
    } catch (e) {
      // 解析失败，跳转到默认页面
      localStorage.setItem('authToken', token);
      localStorage.setItem('userInfo', JSON.stringify(userInfo));
      window.location.href = '../imgassli/index.html';
    }
  } else {
    // 无返回 URL，跳转到默认页面
    localStorage.setItem('authToken', token);
    localStorage.setItem('userInfo', JSON.stringify(userInfo));
    window.location.href = '../imgassli/index.html';
  }
}
```

### 三、云函数 CORS 配置

确保云函数允许目标域名的跨域请求：

```javascript
// 在云函数入口文件（merge/index.js、split/index.js）中添加
const express = require('express');
const app = express();

// CORS 配置
app.use((req, res, next) => {
  // 生产环境中应指定具体域名，如 'https://www.meewoo.me'
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization');
  
  if (req.method === 'OPTIONS') {
    return res.status(200).end();
  }
  next();
});

// 其他路由和逻辑...
```

## 完整流程

### 1. 未登录状态

1. **用户访问目标页面**：用户打开 `https://www.meewoo.me/`
2. **检查登录状态**：目标页面检测到未登录（localStorage 中无 token）
3. **重定向到登录页面**：目标页面重定向到 `https://www.imghlp.com/auth/login.html?returnUrl=https://www.meewoo.me/`

### 2. 登录流程

1. **用户输入凭证**：在 ImgHLP 登录页面输入用户名和密码
2. **验证并生成 token**：登录页面验证凭证（模拟验证）并生成 token
3. **跳回目标页面**：登录成功后，通过 URL 参数携带 token 跳回 `https://www.meewoo.me/?authToken=mock-token-123&userInfo={"username":"test"}`

### 3. 登录成功后

1. **接收并存储 token**：目标页面解析 URL 参数，获取 token 并存储到 localStorage
2. **清理 URL 参数**：移除 URL 中的 token 参数（安全考虑）
3. **调用图片处理服务**：目标页面使用存储的 token 调用 ImgHLP 云函数

### 4. 图片处理流程

1. **用户选择图片**：用户在目标页面选择要处理的图片
2. **调用 merge/split API**：目标页面调用 `ImgHLP_API.merge()` 或 `ImgHLP_API.split()`
3. **添加认证头**：API 函数从 localStorage 获取 token 并添加到请求头
4. **云函数验证 token**：云函数验证请求头中的 token 有效性
5. **处理并返回结果**：云函数处理图片并返回结果
6. **显示处理结果**：目标页面接收并显示处理后的图片

## 安全性保障

1. **HTTPS 传输**：确保所有通信使用 HTTPS，防止 token 被窃取
2. **Token 验证**：云函数严格验证 token 格式和有效性
3. **URL 参数清理**：登录成功后移除 URL 中的 token 参数，避免泄露
4. **CORS 限制**：生产环境中，云函数的 CORS 配置应限制为特定域名
5. **错误处理**：API 调用失败时，友好提示用户并引导重新登录

## 测试方案

1. **本地测试**：使用不同端口模拟不同域名（如 `localhost:8080` 和 `localhost:3000`）
2. **线上测试**：在实际域名环境中测试完整流程
3. **功能测试**：验证登录、图片合并、图片切割功能
4. **边界测试**：测试 token 过期、网络错误等场景
5. **安全测试**：测试跨站脚本攻击防护

## 实现复杂度评估

| 环节          | 复杂度 | 实现难度 | 维护成本 |
| ----------- | --- | ---- | ---- |
| 目标页面登录检查    | 低   | 简单   | 低    |
| 登录页面改造      | 低   | 简单   | 低    |
| 云函数 CORS 配置 | 低   | 简单   | 低    |
| 目标页面 API 实现 | 中   | 中等   | 中    |
| 整体流程测试      | 中   | 中等   | 中    |

## 结论

本方案通过基于 Token 的跨域认证机制，成功解决了不同域名页面共享登录系统并调用图片处理服务的问题。实现简单、流程清晰、安全性高，是一种理想的跨域集成方案。

## 适用场景

* ✅ **多域名应用**：多个不同域名的页面需要共享登录系统

* ✅ **第三方集成**：外部网站集成 ImgHLP 图片处理服务

* ✅ **微前端架构**：不同技术栈的前端应用集成

* ✅ **前后端分离**：前端应用调用后端 API 服务

## 注意事项

1. **生产环境配置**：生产环境中应将 CORS 配置限制为特定域名
2. **Token 管理**：建议添加 token 过期机制，定期刷新
3. **错误处理**：完善的错误处理机制，提升用户体验
4. **性能优化**：图片处理可能耗时较长，建议添加加载状态和超时处理
5. **测试覆盖**：充分测试不同场景，确保方案可靠性

