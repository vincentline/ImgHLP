<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8" />
  <title>MeeWoo - 登录</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- 控制颜色方案，拒绝浏览器自动暗黑模式 -->
  <meta name="color-scheme" content="light dark" />
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="../favicon.png">

  <!-- 外部样式表 -->
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <div id="app" v-cloak>
    <div class="login-container">
      <div class="login-card">
        <div class="login-logo">
          <img src="header_logo_white.png" alt="MeeWoo Logo" />
        </div>

        <div v-if="errorMessage" class="error-message">
          {{ errorMessage }}
        </div>

        <form class="login-form" @submit.prevent="handleLogin">
          <div class="form-group">
            <label for="username">用户名</label>
            <div class="input-wrapper input-wrapper--lg">
              <input 
                type="text" 
                id="username" 
                v-model="form.username" 
                placeholder="请输入用户名" 
                required
                autocomplete="username"
                class="base-input"
                style="font-weight: 500;"
              />
            </div>
          </div>

          <div class="form-group">
            <label for="password">密码</label>
            <div class="input-wrapper input-wrapper--lg" style="position: relative;">
              <input 
                :type="showPassword ? 'text' : 'password'" 
                id="password" 
                v-model="form.password" 
                placeholder="请输入密码" 
                required
                autocomplete="current-password"
                class="base-input"
              />
              <button 
                type="button" 
                @click="togglePasswordVisibility"
                style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; padding: 4px;"
                :title="showPassword ? '隐藏密码' : '显示密码'"
              >
                <svg v-if="!showPassword" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7z"></path>
                  <circle cx="12" cy="12" r="3"></circle>
                </svg>
                <svg v-else xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"></path>
                  <path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"></path>
                  <path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"></path>
                  <line x1="2" y1="2" x2="22" y2="22"></line>
                </svg>
              </button>
            </div>
          </div>

          <div class="form-actions">
            <button 
              type="submit" 
              class="btn-large-secondary" 
              :disabled="isLoading"
            >
              {{ isLoading ? '登录中...' : '登录' }}
            </button>
          </div>
        </form>

        <div class="login-footer">
          <p>还没有账号？<span style="color: #999; cursor: not-allowed;">立即注册（暂不支持）</span></p>
          <p><span style="color: #999; cursor: not-allowed;">忘记密码？（暂不支持）</span></p>
        </div>
      </div>
    </div>

    <div v-if="isLoading" class="loading-overlay">
      <div class="loading-spinner"></div>
    </div>
  </div>

  <!-- Vue.js -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>

  <!-- 登录页面逻辑 -->
  <script>
    new Vue({
      el: '#app',
      data: {
        form: {
          username: '',
          password: ''
        },
        errorMessage: '',
        isLoading: false,
        isDarkMode: false,
        showPassword: false,
        // CloudBase 环境配置
        cloudBaseConfig: {
          env: 'imghlp-5gh0mgfu98b71b4e' // 替换为实际的 CloudBase 环境 ID
        }
      },
      mounted() {
        // 检测系统暗黑模式偏好
        this.checkDarkMode();
        // 监听暗黑模式变化
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
          this.checkDarkMode();
        });
      },
      methods: {
        checkDarkMode() {
          this.isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
          if (this.isDarkMode) {
            document.body.classList.add('dark-mode');
          } else {
            document.body.classList.remove('dark-mode');
          }
        },
        togglePasswordVisibility() {
          this.showPassword = !this.showPassword;
        },
        handleLogin() {
          // 表单验证
          if (!this.form.username || !this.form.password) {
            this.errorMessage = '请输入用户名和密码';
            return;
          }

          // 登录加载
          this.isLoading = true;
          this.errorMessage = '';

          // 调用 CloudBase 登录 API
          fetch('https://tcb-api.tencentcloudapi.com/auth/v1/login', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              env: this.cloudBaseConfig.env,
              username: this.form.username,
              password: this.form.password
            })
          })
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then(result => {
            this.isLoading = false;
            if (result.code === 0) {
              // 登录成功，存储 token
              localStorage.setItem('authToken', result.data.access_token);
              localStorage.setItem('userInfo', JSON.stringify(result.data.user));
              // 跳转到图片处理页面
              window.location.href = '../imgassli/index.html';
            } else {
              this.errorMessage = `登录失败: ${result.message || '未知错误'}`;
            }
          })
          .catch(error => {
            this.isLoading = false;
            this.errorMessage = `登录失败: ${error.message}`;
            console.error('登录错误:', error);
          });
        }
      }
    });
  </script>
</body>

</html>